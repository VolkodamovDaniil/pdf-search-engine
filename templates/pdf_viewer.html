<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ document.original_name }} - –ü—Ä–æ—Å–º–æ—Ç—Ä PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .viewer-container { display: flex; gap: 20px; min-height: 80vh; }
        .pdf-viewer { flex: 2; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-results { flex: 1; max-width: 400px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .result-item:hover { background: #f0f8ff; }
        .result-item.active { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .page-nav { margin: 15px 0; text-align: center; }
        .btn { padding: 8px 16px; margin: 0 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-outline { background: transparent; border: 1px solid #007bff; color: #007bff; }
        .btn-outline:hover { background: #007bff; color: white; }
        .page-input { width: 60px; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .search-highlight { background: yellow; padding: 2px 0; }
        .results-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
        .no-results { color: #666; font-style: italic; text-align: center; padding: 20px; }
        .document-info { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .page-indicator { font-weight: bold; color: #007bff; margin: 0 10px; }
        #pdf-canvas { border: 1px solid #ddd; margin: 0 auto; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pdf-controls { margin: 15px 0; text-align: center; }
        .zoom-controls { margin: 10px 0; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÑ {{ document.original_name }}</h1>
        <div class="document-info">
            <strong>–†–∞–∑–º–µ—Ä:</strong> {{ (document.file_size / 1024)|round(2) }} –ö–ë | 
            <strong>–Ø–∑—ã–∫:</strong> {{ document.language }} | 
            <strong>–ó–∞–≥—Ä—É–∂–µ–Ω:</strong> {{ document.upload_date.strftime('%Y-%m-%d %H:%M') }} |
            <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ document.category or '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{{ url_for('index') }}" class="btn" style="background: #6c757d;">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            
            <a href="{{ url_for('export_tables', doc_id=document.id) }}" 
            class="btn" style="background: #17a2b8;">
                üìã –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü
            </a>
        </div>
        
        {% if query %}
        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px;">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</strong> "{{ query }}"
            <span class="page-indicator">–ù–∞–π–¥–µ–Ω–æ: {{ search_results|length }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
        </div>
        {% endif %}
        
        {% if document.category %}
        <div style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px;">
            <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ document.category }}
            {% if document.file_info and document.file_info.categorization_confidence %}
            <span style="color: #666;">(—Ç–æ—á–Ω–æ—Å—Ç—å: {{ document.file_info.categorization_confidence|round(1) }}%)</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="viewer-container">
        <div class="pdf-viewer">
            <div class="pdf-controls">
                <div class="page-nav">
                    <button class="btn" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
                    <input type="number" id="pageInput" class="page-input" value="1" min="1" max="{{ total_pages }}" onchange="goToPage(parseInt(this.value))">
                    <span>–∏–∑ {{ total_pages }}</span>
                    <button class="btn" onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                </div>
                <div class="zoom-controls">
                    <button class="btn btn-outline" onclick="changeZoom(-0.2)">–£–º–µ–Ω—å—à–∏—Ç—å</button>
                    <span>–ú–∞—Å—à—Ç–∞–±: <span id="zoom-level">100</span>%</span>
                    <button class="btn btn-outline" onclick="changeZoom(0.2)">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
                    <button class="btn btn-outline" onclick="fitToWidth()">–ü–æ —à–∏—Ä–∏–Ω–µ</button>
                </div>
            </div>
            
            <div id="pdf-container" style="text-align: center; margin: 20px 0;">
                <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ PDF... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
                <canvas id="pdf-canvas" style="display: none;"></canvas>
            </div>
        </div>

        <div class="search-results">
            <div class="results-header">
                <h3>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h3>
                {% if query %}
                <p>–ù–∞–π–¥–µ–Ω–æ {{ search_results|length }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è "{{ query }}"</p>
                {% endif %}
            </div>
            
            {% if search_results %}
                {% for result in search_results %}
                <div class="result-item" id="result-{{ loop.index }}" onclick="goToPage({{ result.chunk.page_number }}, '{{ query }}')">
                    <div class="result-header">
                        <strong>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ result.chunk.page_number }}</strong>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                        <div class="context-preview">
                        {{ result.context|safe }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-results">
                    {% if query %}
                    <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è "{{ query }}"</p>
                    {% else %}
                    <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let canvas = document.getElementById('pdf-canvas');
        let ctx = canvas.getContext('2d');
        const pdfUrl = "{{ url_for('serve_pdf', filename=document.filename) }}";

        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            pdfDoc = pdf;
            document.getElementById('pageInput').max = pdf.numPages;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('pdf-canvas').style.display = 'block';
            renderPage(pageNum);
            
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('q');
            
            if (searchQuery && {{ search_results|length }} > 0) {
                const firstResultPage = {{ search_results[0].chunk.page_number if search_results else 1 }};
                setTimeout(() => goToPage(firstResultPage), 100);
            }
        }).catch(function(error) {
            document.getElementById('loading').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF: ' + error.message;
        });

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    pageNum = num;
                    document.getElementById('pageInput').value = pageNum;
                    document.getElementById('zoom-level').textContent = Math.round(scale * 100);
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        }

        function changePage(delta) {
            const newPage = pageNum + delta;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                goToPage(newPage);
            }
        }

        function goToPage(num) {
            if (num < 1) num = 1;
            if (num > pdfDoc.numPages) num = pdfDoc.numPages;
            
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function changeZoom(delta) {
            scale += delta;
            if (scale < 0.5) scale = 0.5;
            if (scale > 3.0) scale = 3.0;
            renderPage(pageNum);
        }

        function fitToWidth() {
            pdfDoc.getPage(pageNum).then(function(page) {
                const containerWidth = document.getElementById('pdf-container').clientWidth - 40;
                const pageWidth = page.getViewport({ scale: 1.0 }).width;
                scale = containerWidth / pageWidth;
                renderPage(pageNum);
            });
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                changePage(-1);
            } else if (event.key === 'ArrowRight') {
                changePage(1);
            } else if (event.key === '+' || event.key === '=') {
                changeZoom(0.2);
                event.preventDefault();
            } else if (event.key === '-') {
                changeZoom(-0.2);
                event.preventDefault();
            }
        });

        window.addEventListener('load', fitToWidth);
        window.addEventListener('resize', fitToWidth);
    </script>
</body>
</html>